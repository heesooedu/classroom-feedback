<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>학생 접속</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f8f9fa; }
        .sidebar { height: 100vh; overflow-y: auto; background: white; border-right: 1px solid #dee2e6; }
        .main-view { height: 100vh; overflow-y: auto; padding: 20px; }
        #code { font-family: 'Consolas', 'Monaco', monospace; font-size: 14px; tab-size: 4; }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="row">
        <!-- 사이드바 -->
        <div class="col-md-3 sidebar p-3">
            <h6 class="text-muted" id="currentChapter">대기 중...</h6>
            <div class="list-group mt-3" id="problemList"></div>
            <div class="mt-4 pt-3 border-top text-center">
                <button class="btn btn-outline-danger btn-sm w-100" onclick="logout()">로그아웃 (종료)</button>
            </div>
        </div>
        
        <!-- 메인 -->
        <div class="col-md-9 main-view">
            <div class="d-flex justify-content-between mb-4">
                <h3 id="pTitle">문제를 선택하세요</h3>
                <span class="badge bg-dark fs-6" id="userInfo"></span>
            </div>
            <div id="pDesc" class="alert alert-secondary">좌측 목록에서 문제를 선택하세요.</div>
            
            <div id="editorArea" style="display:none;">
                <textarea id="code" class="form-control mb-3" rows="15" placeholder="코드를 작성하세요..." spellcheck="false"></textarea>
                <button class="btn btn-primary" onclick="submitCode()" id="subBtn">제출</button>
                
                <!-- AI 결과 영역 -->
                <div id="aiResult" class="mt-3 p-3 bg-white border rounded shadow-sm" style="display:none;">
                    <h5>AI 점수: <span id="aiScore" class="fw-bold text-primary"></span></h5>
                    
                    <!-- 로딩 바 -->
                    <div id="queueLoading" class="progress mt-2" style="display:none;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-info" style="width: 100%">채점 순서를 기다리는 중입니다...</div>
                    </div>

                    <!-- 피드백 박스 -->
                    <div class="alert alert-info mt-2" id="feedbackBox" style="display:none;">
                        <strong>AI 피드백:</strong>
                        <p id="aiFeedback" class="mb-0" style="white-space: pre-wrap;"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 로그인 모달 -->
<div class="modal fade" id="loginModal" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">수업 참여</h5></div>
            <div class="modal-body">
                <div class="mb-3">
                    <label>참여할 수업 선택</label>
                    <select id="loginClassSelect" class="form-select"><option>로딩 중...</option></select>
                    <small class="text-muted text-danger" id="loadingMsg">교사가 입장한 수업만 표시됩니다.</small>
                </div>
                <div class="mb-3"><input type="text" id="loginNum" class="form-control" placeholder="학번"></div>
                <div class="mb-3"><input type="text" id="loginName" class="form-control" placeholder="이름"></div>
            </div>
            <div class="modal-footer"><button class="btn btn-primary" onclick="login()">입장</button></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let user = null;
    let currentPid = null;
    let pollingInterval = null;
    const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));

    async function init() {
        const res = await fetch('/api/student/active_classes');
        const activeClasses = await res.json();
        
        const sel = document.getElementById('loginClassSelect');
        sel.innerHTML = "";
        if (activeClasses.length === 0) {
            sel.innerHTML = "<option disabled selected>대기 중</option>";
            document.getElementById('loadingMsg').innerText = "교사가 수업을 시작해야 합니다.";
        } else {
            document.getElementById('loadingMsg').innerText = "";
            activeClasses.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id; opt.innerText = c.display_name;
                sel.appendChild(opt);
            });
        }
        const stored = localStorage.getItem('s_user');
        if (stored) { user = JSON.parse(stored); loginModal.hide(); afterLogin(); } 
        else loginModal.show();
        enableSmartIndent();
    }

    async function login() {
        const cid = document.getElementById('loginClassSelect').value;
        const num = document.getElementById('loginNum').value.trim();
        const name = document.getElementById('loginName').value.trim();
        if (!cid || !num || !name) return alert("입력 확인");
        const res = await fetch('/api/login', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({classroom_id: cid, student_number: num, name: name})
        });
        user = await res.json();
        localStorage.setItem('s_user', JSON.stringify(user));
        loginModal.hide(); afterLogin();
    }

    function afterLogin() {
        document.getElementById('userInfo').innerText = `${user.class_name} ${user.name}`;
        loadProblems();
    }

    function logout() {
        if(confirm("종료하시겠습니까?")) {
            localStorage.removeItem('s_user'); location.reload();
        }
    }

    async function loadProblems() {
        if(pollingInterval) clearInterval(pollingInterval); // 문제 이동 시 폴링 중단

        const res = await fetch(`/api/problems?student_id=${user.id}`);
        if(res.status !== 200) { alert("오류"); logout(); return; }
        const data = await res.json();
        
        document.getElementById('currentChapter').innerText = "현재: " + data.active_chapter;
        const list = document.getElementById('problemList');
        list.innerHTML = "";
        
        data.problems.forEach(p => {
            const a = document.createElement('a');
            a.id = `problem-item-${p.id}`;
            a.className = "list-group-item list-group-item-action d-flex justify-content-between align-items-center";
            if(p.id == currentPid) a.classList.add('active');
            let badgeHtml = p.has_submission ? '<span class="badge bg-success rounded-pill">제출됨</span>' : '';
            a.innerHTML = `<span>${p.title}</span> ${badgeHtml}`;
            
            a.onclick = () => {
                currentPid = p.id;
                document.getElementById('pTitle').innerText = p.title;
                document.getElementById('pDesc').innerText = p.description;
                document.getElementById('editorArea').style.display = 'block';
                
                // 화면 초기화
                document.getElementById('aiResult').style.display = 'none';
                document.getElementById('queueLoading').style.display = 'none';
                document.getElementById('feedbackBox').style.display = 'none';

                if (p.has_submission) {
                    document.getElementById('code').value = p.last_code || "";
                    document.getElementById('aiResult').style.display = 'block';
                    
                    if (p.status === 'grading') {
                        // 채점 중이면 로딩 표시
                        document.getElementById('aiScore').innerText = "채점 중...";
                        document.getElementById('queueLoading').style.display = 'block';
                    } else {
                        // 완료면 결과 표시
                        document.getElementById('aiScore').innerText = p.last_score + "점";
                        document.getElementById('aiFeedback').innerText = p.last_feedback;
                        document.getElementById('feedbackBox').style.display = 'block';
                    }
                } else {
                    document.getElementById('code').value = "";
                }
                
                document.querySelectorAll('.list-group-item').forEach(el => el.classList.remove('active'));
                a.classList.add('active');
            };
            list.appendChild(a);
        });
    }

    async function submitCode() {
        if(!currentPid) return;
        const code = document.getElementById('code').value;
        if(!code.trim()) return alert("코드를 입력하세요.");

        const btn = document.getElementById('subBtn');
        btn.disabled = true; btn.innerText = "대기열 등록 중...";

        // 1. 제출 요청
        const res = await fetch('/api/submit', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({student_id: user.id, problem_id: currentPid, code_answer: code})
        });
        const submission = await res.json();

        // 2. 화면을 '채점 대기' 상태로 전환
        document.getElementById('aiResult').style.display = 'block';
        document.getElementById('aiScore').innerText = "채점 대기 중...";
        document.getElementById('feedbackBox').style.display = 'none';
        document.getElementById('queueLoading').style.display = 'block';
        
        // 3. 폴링 시작 (3초마다 확인)
        if(pollingInterval) clearInterval(pollingInterval);
        
        pollingInterval = setInterval(async () => {
            try {
                console.log("Polling submission status..."); // 디버깅용
                const checkRes = await fetch(`/api/check_submission/${submission.id}`);
                const checkData = await checkRes.json();
                
                if (checkData.status === 'completed') {
                    clearInterval(pollingInterval); // 완료되면 폴링 중단
                    
                    // UI 업데이트
                    document.getElementById('queueLoading').style.display = 'none';
                    document.getElementById('feedbackBox').style.display = 'block';
                    document.getElementById('aiScore').innerText = checkData.score + "점";
                    document.getElementById('aiFeedback').innerText = checkData.ai_feedback;
                    
                    btn.disabled = false; btn.innerText = "제출";
                    
                    // 뱃지 추가
                    const activeItem = document.getElementById(`problem-item-${currentPid}`);
                    if(activeItem && !activeItem.querySelector('.badge')) {
                        activeItem.innerHTML += ' <span class="badge bg-success rounded-pill">제출됨</span>';
                    }
                }
            } catch (e) {
                console.error("Polling error", e);
            }
        }, 3000);
    }


    // [IDE 기능] 탭, 자동 들여쓰기, 그리고 스마트 백스페이스
    function enableSmartIndent() {
        const textarea = document.getElementById('code');
        
        textarea.addEventListener('keydown', function(e) {
            // 1. Tab 키: 공백 4칸 삽입
            if (e.key === 'Tab') {
                e.preventDefault();
                document.execCommand('insertText', false, '    ');
            } 
            // 2. Enter 키: 자동 들여쓰기
            else if (e.key === 'Enter') {
                e.preventDefault();
                const cursorPos = this.selectionStart;
                const currentVal = this.value;
                const lastNewLine = currentVal.lastIndexOf('\n', cursorPos - 1);
                const currentLine = currentVal.substring(lastNewLine + 1, cursorPos);
                
                // 현재 줄의 들여쓰기 감지
                const match = currentLine.match(/^(\s*)/);
                let indent = match ? match[1] : '';
                
                // 콜론(:)으로 끝나면 들여쓰기 추가
                if (currentLine.trim().endsWith(':')) {
                    indent += '    ';
                }
                
                document.execCommand('insertText', false, '\n' + indent);
            }
            // 3. Backspace 키: 4칸 공백 한 번에 지우기 (내어쓰기)
            else if (e.key === 'Backspace') {
                const cursorPos = this.selectionStart;
                const selectionEnd = this.selectionEnd;

                // 드래그 선택 중일 때는 기본 동작(선택 삭제) 따름
                if (cursorPos !== selectionEnd) return;

                // 커서 앞 4글자가 공백('    ')인지 확인
                if (this.value.substring(cursorPos - 4, cursorPos) === '    ') {
                    e.preventDefault();
                    
                    // 공백 4개를 선택 영역으로 잡은 뒤 삭제 명령 실행
                    // (이렇게 해야 브라우저의 실행 취소(Ctrl+Z) 기록이 꼬이지 않음)
                    this.setSelectionRange(cursorPos - 4, cursorPos);
                    document.execCommand('delete');
                }
            }
        });
    }

    init();
</script>
</body>
</html>