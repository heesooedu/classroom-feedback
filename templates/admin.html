<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>AI êµì‚¬ ëŒ€ì‹œë³´ë“œ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-cell { cursor: pointer; text-align: center; font-weight: bold; vertical-align: middle; }
        .status-grading { background: #ffecb5; animation: blink 1s infinite; }
        .status-pass { background: #d4edda; color: #155724; }
        .status-fail { background: #f8d7da; color: #721c24; }
        @keyframes blink { 50% { opacity: 0.5; } }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; border: 1px solid #dee2e6; max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-dark bg-dark mb-4">
    <div class="container-fluid">
        <span class="navbar-brand">AI Class System</span>
        <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-success" onclick="openSetupModal()">+ ê³¼ëª© ê°œì„¤</button>
            <button class="btn btn-outline-light btn-sm" onclick="location.reload()">ìƒˆë¡œê³ ì¹¨</button>
        </div>
    </div>
</nav>

<div class="container">
    <!-- 1. ìˆ˜ì—… ì„ íƒ ì˜ì—­ -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h5 class="card-title mb-3">ìˆ˜ì—… ì…ì¥</h5>
            <div class="row g-2 align-items-end">
                <div class="col-md-5">
                    <label class="text-muted small">1. ê³¼ëª© ì„ íƒ</label>
                    <select id="courseSelect" class="form-select" onchange="filterClasses()">
                        <option value="" disabled selected>ê°œì„¤ëœ ê³¼ëª©ì„ ì„ íƒí•˜ì„¸ìš”</option>
                    </select>
                </div>
                <div class="col-md-5">
                    <label class="text-muted small">2. ë°˜ ì„ íƒ</label>
                    <select id="activeClassSelect" class="form-select">
                        <option value="" disabled selected>ê³¼ëª©ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary w-100" onclick="startClass()">ì…ì¥ (ìˆ˜ì—… ì‹œì‘)</button>
                </div>
            </div>
            <p class="text-danger small mt-2 mb-0">* 'ì…ì¥' ë²„íŠ¼ì„ ëˆŒëŸ¬ì•¼ í•™ìƒë“¤ í™”ë©´ì— í•´ë‹¹ ìˆ˜ì—…ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</p>
        </div>
    </div>

    <!-- 2. ìˆ˜ì—… ì œì–´ ë° í˜„í™©íŒ -->
    <div id="dashboardArea" style="display:none;">
        <div class="card mb-3 border-primary">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <h4 id="currentClassTitle" class="mb-0">-</h4>
                    <small class="text-muted">ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ì¤‘ (ì´ ë°˜ë§Œ í™œì„±í™”ë¨)</small>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <label class="fw-bold">ë¬¸ì œì§€ ë°°ë¶€:</label>
                    <select id="chapterControl" class="form-select w-auto"></select>
                    <button class="btn btn-danger" onclick="changeChapter()">ì ìš©</button>
                </div>
            </div>
        </div>

        <table class="table table-bordered table-hover bg-white shadow-sm text-center">
            <thead class="table-light" id="tableHead"></thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<!-- ëª¨ë‹¬ë“¤ -->
<div class="modal fade" id="setupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">ìƒˆ ê³¼ëª© ê°œì„¤</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <div class="mb-3"><label>ê³¼ëª© ì„ íƒ</label><select id="setupCourseSelect" class="form-select"></select></div>
                <div class="mb-3"><label>ë°˜ ëª©ë¡</label><input type="text" id="setupClasses" class="form-control" placeholder="1ë°˜, 2ë°˜"></div>
            </div>
            <div class="modal-footer"><button class="btn btn-primary" onclick="runSetup()">ê°œì„¤</button></div>
        </div>
    </div>
</div>

<!-- [í•µì‹¬ 2] ìƒì„¸ ë³´ê¸° ëª¨ë‹¬ UI ê°œì„  -->
<div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-xl"> <!-- ë„“ì€ ëª¨ë‹¬ ì‚¬ìš© -->
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ì œì¶œ ìƒì„¸ ì •ë³´</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- ì™¼ìª½: í•™ìƒ ì½”ë“œ -->
                    <div class="col-md-6 border-end">
                        <h6 class="fw-bold text-dark">ğŸ“œ í•™ìƒì´ ì œì¶œí•œ ë‹µì•ˆ</h6>
                        <pre id="mCode"></pre>
                    </div>
                    <!-- ì˜¤ë¥¸ìª½: AI í”¼ë“œë°± -->
                    <div class="col-md-6">
                        <h6 class="fw-bold text-primary">ğŸ¤– AI ì±„ì  ê²°ê³¼ (<span id="mScore"></span>ì )</h6>
                        <div class="alert alert-light border">
                            <p id="mFeedback" style="white-space: pre-wrap;"></p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let currentClassId = null;
    let allData = null; 
    let submissionData = {}; // [ì¤‘ìš”] ì œì¶œ ë°ì´í„°ë¥¼ ì €ì¥í•  ì „ì—­ ê°ì²´
    const setupModal = new bootstrap.Modal(document.getElementById('setupModal'));
    const detailModal = new bootstrap.Modal(document.getElementById('detailModal'));

    async function init() {
        const res = await fetch('/api/system/info');
        allData = await res.json();
        if (!allData.initialized) openSetupModal();
        else renderCourseSelect();
    }

    function openSetupModal() {
        const sel = document.getElementById('setupCourseSelect');
        sel.innerHTML = "";
        if (allData && allData.available_courses_in_yaml) {
            allData.available_courses_in_yaml.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c; opt.innerText = c;
                sel.appendChild(opt);
            });
        }
        setupModal.show();
    }

    async function runSetup() {
        const name = document.getElementById('setupCourseSelect').value;
        const classesStr = document.getElementById('setupClasses').value;
        if(!name || !classesStr) return alert("ì…ë ¥ í™•ì¸");
        await fetch('/api/system/setup', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({course_name: name, class_names: classesStr.split(',')})
        });
        alert("ê°œì„¤ ì™„ë£Œ"); setupModal.hide(); init();
    }

    function renderCourseSelect() {
        const cSel = document.getElementById('courseSelect');
        cSel.innerHTML = '<option value="" disabled selected>ê³¼ëª© ì„ íƒ</option>';
        allData.courses.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.id; opt.innerText = c.name;
            cSel.appendChild(opt);
        });
    }

    function filterClasses() {
        const cid = parseInt(document.getElementById('courseSelect').value);
        const classSel = document.getElementById('activeClassSelect');
        const filtered = allData.classes.filter(cls => cls.course_id === cid);
        classSel.innerHTML = "";
        filtered.forEach(cls => {
            const opt = document.createElement('option');
            opt.value = cls.id; opt.innerText = cls.name;
            opt.setAttribute('data-chapter', cls.active_chapter);
            classSel.appendChild(opt);
        });
    }

    async function startClass() {
        const sel = document.getElementById('activeClassSelect');
        if(!sel.value) return alert("ë°˜ ì„ íƒ");

        currentClassId = sel.value;
        const className = sel.options[sel.selectedIndex].text;
        const courseName = document.getElementById('courseSelect').options[document.getElementById('courseSelect').selectedIndex].text;

        await fetch('/api/admin/activate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({classroom_id: currentClassId})
        });

        document.getElementById('dashboardArea').style.display = 'block';
        document.getElementById('currentClassTitle').innerText = `[${courseName}] ${className}`;
        
        const chSel = document.getElementById('chapterControl');
        chSel.innerHTML = "";
        (allData.chapters_by_course[courseName] || []).forEach(ch => {
            const opt = document.createElement('option');
            opt.value = ch; opt.innerText = ch;
            chSel.appendChild(opt);
        });
        document.getElementById('chapterControl').value = sel.options[sel.selectedIndex].getAttribute('data-chapter');

        fetchStatus();
    }

    async function changeChapter() {
        await fetch('/api/admin/progress', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({classroom_id: currentClassId, active_chapter: document.getElementById('chapterControl').value})
        });
        alert("ë°°ë¶€ ì™„ë£Œ"); fetchStatus();
    }

    async function fetchStatus() {
        if(!currentClassId) return;
        const res = await fetch(`/api/status?classroom_id=${currentClassId}`);
        const data = await res.json();
        renderTable(data);
    }

    function renderTable(data) {
        let h = `<tr><th>ì´ë¦„</th>`;
        data.problems.forEach(p => h += `<th>${p.title}</th>`);
        document.getElementById('tableHead').innerHTML = h + "</tr>";

        const tb = document.getElementById('tableBody');
        tb.innerHTML = "";
        
        // ë°ì´í„° ì´ˆê¸°í™”
        submissionData = {};

        data.students.forEach(st => {
            let row = `<tr><td>${st.info}</td>`;
            data.problems.forEach(p => {
                const item = st.problems[p.id];
                let cls = 'bg-light';
                let txt = '-';
                
                // ê³ ìœ  í‚¤ ìƒì„± (í•™ìƒID_ë¬¸ì œID)
                const uniqueKey = `${st.info}_${p.id}`; 
                
                if(item.status === 'grading') { 
                    cls = 'status-grading'; txt = '...'; 
                } else if(item.status === 'completed') {
                    txt = item.score;
                    cls = item.score >= 80 ? 'status-pass' : 'status-fail';
                    
                    // [ì¤‘ìš”] ë°ì´í„°ë¥¼ ì „ì—­ ê°ì²´ì— ì €ì¥ (HTML ì†ì„±ì— ë„£ì§€ ì•ŠìŒ)
                    submissionData[uniqueKey] = item;
                }

                // onclickì— IDë§Œ ì „ë‹¬
                row += `<td class="status-cell ${cls}" onclick="openDetailModal('${uniqueKey}')">${txt}</td>`;
            });
            tb.innerHTML += row + "</tr>";
        });
    }

    function openDetailModal(key) {
        const item = submissionData[key];
        if(!item) return; // ë°ì´í„° ì—†ìœ¼ë©´ ë¬´ì‹œ

        document.getElementById('mCode').innerText = item.code || "ë‚´ìš© ì—†ìŒ";
        document.getElementById('mScore').innerText = item.score;
        document.getElementById('mFeedback').innerText = item.feedback || "í”¼ë“œë°± ì—†ìŒ";
        
        detailModal.show();
    }

    document.addEventListener('DOMContentLoaded', init);
    setInterval(fetchStatus, 3000);
</script>
</body>
</html>